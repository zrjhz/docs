# æ·±æ‹·è´

æœ¬æ–‡å°†ä»æœ€åŸºç¡€çš„æ·±æ‹·è´æ–¹æ³•åˆ°æ›´å¤æ‚çš„æ–¹æ³•ï¼Œæ·±å…¥è®²è§£æ·±æ‹·è´çš„åŸç†ï¼Œä»¥åŠå„æ–¹æ³•ä¹‹é—´çš„å·®å¼‚ã€‚

## JSON.parse(JSON.stringify())

åœ¨ä¸ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“çš„æƒ…å†µä¸‹ï¼Œæƒ³è¦æ·±æ‹·è´ä¸€ä¸ªå¯¹è±¡ï¼Œä¸€èˆ¬æ¥è®²æœ€ç®€å•çš„ç”¨çš„æœ€å¤šçš„å°±æ˜¯ `JSON.parse(JSON.stringify(obj))`ï¼Œå…¶è¿‡ç¨‹è¯´ç™½äº†å°±æ˜¯åˆ©ç”¨ `JSON.stringify` å°† JS å¯¹è±¡åºåˆ—åŒ–ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰ï¼Œå†ä½¿ç”¨ `JSON.parse` æ¥ååºåˆ—åŒ–(è¿˜åŸ) JS å¯¹è±¡ã€‚

```js
JSON.parse(JSON.stringify(obj));
```

è¿™ç§å†™æ³•éå¸¸ç®€å•ï¼Œè€Œä¸”å¯ä»¥åº”å¯¹å¤§éƒ¨åˆ†çš„åº”ç”¨åœºæ™¯ï¼Œä½†æ³¨æ„ JSON åªèƒ½ç”¨æ¥åºåˆ—åŒ–å¯¹è±¡ã€æ•°ç»„ã€æ•°å€¼ã€å­—ç¬¦ä¸²ã€å¸ƒå°”å€¼å’Œ `null`ï¼Œä¾é  JSON æ·±æ‹·è´æ—¶å­˜åœ¨å¾ˆå¤§ç¼ºé™·ï¼ŒåŸå› åœ¨äº `JSON.stringify()` åœ¨åºåˆ—åŒ–æ—¶ä¼šæœ‰ä»¥ä¸‹é—®é¢˜ï¼š

1ã€æ—¶é—´å¯¹è±¡åºåˆ—åŒ–åä¼šå˜æˆå­—ç¬¦ä¸²ï¼›

```js
const target = {
    name: 'Jack',
    date: [new Date(1536627600000), new Date(1540047600000)]
};
JSON.parse(JSON.stringify(target));
```

![image](../../assert/204478796-247f5581-845a-490a-a9f7-6c5fa7cc54b8.png)

> Date æ—¥æœŸè°ƒç”¨äº† toJSON() å°†å…¶è½¬æ¢ä¸ºäº† string å­—ç¬¦ä¸²ï¼ˆåŒ Date.toISOString()ï¼‰ï¼Œå› æ­¤ä¼šè¢«å½“åšå­—ç¬¦ä¸²å¤„ç†ã€‚

```js
JSON.stringify(new Date(1536627600000));
// '"2018-09-11T01:00:00.000Z"'
```

2ã€RegExpã€Error å¯¹è±¡åºåˆ—åŒ–åå°†åªå¾—åˆ°ç©ºå¯¹è±¡ï¼›

```js
const target = {
    re: new RegExp("\\w+"),
    err: new Error('"x" is not defined')
};
JSON.stringify(target);
// '{"re":{},"err":{}}'
```

![image](../../assert/204478872-676802bc-df95-401f-b872-0005cfd47af7.png)

3ã€ä»»æ„çš„å‡½æ•°ã€`undefined` ä»¥åŠ symbol å€¼ï¼Œåœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­ä¼šè¢«å¿½ç•¥ï¼›

```js
const target = {
    func: function () {
        console.log(1)
    },
    val: undefined,
    sym: Symbol('foo')
};
JSON.stringify(target);
// '{}'
```

![image](../../assert/204478927-b836fbed-e3e5-4415-a737-d670a432e5fc.png)

4ã€NaN å’Œ Infinity æ ¼å¼çš„æ•°å€¼éƒ½ä¼šè¢«å½“åš nullï¼›

- `1.7976931348623157E+10308` æ˜¯æµ®ç‚¹æ•°çš„æœ€å¤§ä¸Šé™ æ˜¾ç¤ºä¸º Infinity
- `-1.7976931348623157E+10308` æ˜¯æµ®ç‚¹æ•°çš„æœ€å°ä¸‹é™ æ˜¾ç¤ºä¸º -Infinity

[![image](../../assert/204478982-30468b99-5aab-4f1f-a1e2-edec609ba7f9.png)](https://user-images.githubusercontent.com/93993961/204478982-30468b99-5aab-4f1f-a1e2-edec609ba7f9.png)

```
const target = {
    nan: NaN,
    infinityMax: 1.7976931348623157E+10308,
    infinityMin: -1.7976931348623157E+10308,
};
JSON.stringify(target);
// '{"nan":null,"infinityMax":null,"infinityMin":null}'
```

[![image](../../assert/204479012-45e67678-35ff-4fcf-97a3-e654b59f5137.png)](https://user-images.githubusercontent.com/93993961/204479012-45e67678-35ff-4fcf-97a3-e654b59f5137.png)

5ã€å¯¹åŒ…å«å¾ªç¯å¼•ç”¨çš„å¯¹è±¡ï¼ˆå¯¹è±¡ä¹‹é—´ç›¸äº’å¼•ç”¨ï¼Œå½¢æˆæ— é™å¾ªç¯ï¼‰åºåˆ—åŒ–ï¼Œä¼šæŠ›å‡ºé”™è¯¯ã€‚

```js
var circularReference = { otherData: 123 };
circularReference.myself = circularReference;
JSON.stringify(circularReference);
// TypeError: cyclic object value(Firefox) æˆ– Uncaught TypeError: Converting circular structure to JSON(Chrome and Opera)
```

[![image](../../assert/204479048-6a4acd7b-76ea-462b-8bad-6cb1befbc0c3.png)](https://user-images.githubusercontent.com/93993961/204479048-6a4acd7b-76ea-462b-8bad-6cb1befbc0c3.png)

> åœ¨ JSON ä¸­å‡ºç°å¾ªç¯å¼•ç”¨æ—¶ï¼ŒJavaScript ä¼šæŠ›å‡º "cyclic object value" çš„å¼‚å¸¸ã€‚`JSON.stringify()` å¹¶ä¸ä¼šå°è¯•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå› æ­¤å¯¼è‡´è¿è¡Œå¤±è´¥ã€‚
>
> - æç¤ºä¿¡æ¯:
> - TypeError: cyclic object value (Firefox)
> - TypeError: Converting circular structure to JSON (Chrome and Opera)
> - TypeError: Circular reference in value argument not supported (Edge)

## é€’å½’

é€šè¿‡é€’å½’å®ç°æ·±æ‹·è´ï¼š

```js
function deepClone(obj) { // é€’å½’æ‹·è´
    if (typeof obj !== 'object' || obj === null) return obj; // å¦‚æœä¸æ˜¯å¤æ‚æ•°æ®ç±»å‹ æˆ–è€…ä¸ºnullï¼Œç›´æ¥è¿”å›
    if (obj instanceof RegExp) return new RegExp(obj);
    if (obj instanceof Date) return new Date(obj);
    let cloneObj = Array.isArray(obj) ? [] : {};
    for (let key in obj) {
        // åˆ¤æ–­æ˜¯å¦æ˜¯å¯¹è±¡è‡ªèº«çš„å±æ€§ï¼Œç­›æ‰å¯¹è±¡åŸå‹é“¾ä¸Šç»§æ‰¿çš„å±æ€§
        if (obj.hasOwnProperty(key)) {
            // å¦‚æœ obj[key] æ˜¯å¤æ‚æ•°æ®ç±»å‹ï¼Œé€’å½’
            cloneObj[key] = deepClone(obj[key]);
        }
    }
    return cloneObj;
}
```

æˆ‘ä»¬åº”è¯¥æ‹·è´è¦æ‹·è´å¯¹è±¡è‡ªèº«çš„å±æ€§ï¼Œå¯¹è±¡åŸå‹ä¸Šçš„å±æ€§æˆ‘ä»¬ä¸åº”è¯¥æ‹·è´ï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨åˆ° `hasOwnProperty()` æ–¹æ³•æ¥è§£å†³ã€‚

**`hasOwnProperty()` æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥ç”¨æ¥æ£€æµ‹ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å«æœ‰ç‰¹å®šçš„è‡ªèº«å±æ€§ï¼›è¯¥æ–¹æ³•ä¼šå¿½ç•¥æ‰é‚£äº›ä»åŸå‹é“¾ä¸Šç»§æ‰¿åˆ°çš„å±æ€§ã€‚**

### å¾ªç¯å¼•ç”¨

å¾ªç¯å¼•ç”¨ä¼šä½¿é€’å½’è¿›å…¥æ­»å¾ªç¯å¯¼è‡´æ ˆå†…å­˜æº¢å‡ºã€‚

æˆ‘ä»¬æ‹·è´ä¸€ä¸‹å‰é¢å¾ªç¯å¼•ç”¨çš„ä¾‹å­ï¼š

```js
var circularReference = { otherData: 123 };
circularReference.myself = circularReference;
deepClone(circularReference);
// Uncaught RangeError: Maximum call stack size exceeded è¶…å‡ºæœ€å¤§è°ƒç”¨å †æ ˆå¤§å°
```

è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œå¯ä»¥é¢å¤–å¼€è¾Ÿä¸€ä¸ªå­˜å‚¨ç©ºé—´ï¼Œæ¥å­˜å‚¨å½“å‰å¯¹è±¡å’Œæ‹·è´å¯¹è±¡çš„å¯¹åº”å…³ç³»ï¼Œå½“éœ€è¦æ‹·è´å½“å‰å¯¹è±¡æ—¶ï¼Œå…ˆå»å­˜å‚¨ç©ºé—´ä¸­æ‰¾ï¼Œæœ‰æ²¡æœ‰æ‹·è´è¿‡è¿™ä¸ªå¯¹è±¡ï¼Œå¦‚æœæœ‰çš„è¯ç›´æ¥è¿”å›ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ç»§ç»­æ‹·è´ï¼Œè¿™æ ·å°±å·§å¦™åŒ–è§£çš„å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚

è¿™ä¸ªå­˜å‚¨ç©ºé—´ï¼Œéœ€è¦å¯ä»¥å­˜å‚¨ `key-value` å½¢å¼çš„æ•°æ®ï¼Œä¸” **`key` å¯ä»¥æ˜¯ä¸€ä¸ªå¼•ç”¨ç±»å‹**ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹© `Map` è¿™ç§æ•°æ®ç»“æ„ï¼š

- æ£€æŸ¥ `map` ä¸­æœ‰æ— å…‹éš†è¿‡çš„å¯¹è±¡
- æœ‰ - ç›´æ¥è¿”å›
- æ²¡æœ‰ - å°†å½“å‰å¯¹è±¡ä½œä¸º `key`ï¼Œå…‹éš†å¯¹è±¡ä½œä¸º `value` è¿›è¡Œå­˜å‚¨
- ç»§ç»­å…‹éš†

```js
function deepClone(obj, map = new Map()) { // é€’å½’æ‹·è´
    if (typeof obj !== 'object' || obj === null) return obj; // å¦‚æœä¸æ˜¯å¤æ‚æ•°æ®ç±»å‹ æˆ–è€…ä¸ºnullï¼Œç›´æ¥è¿”å›
    if (obj instanceof RegExp) return new RegExp(obj);
    if (obj instanceof Date) return new Date(obj);
    if (map.has(obj)) return map.get(obj);
    let cloneObj = Array.isArray(obj) ? [] : {};
    map.set(obj, cloneObj);
    for (let key in obj) {
        // åˆ¤æ–­æ˜¯å¦æ˜¯å¯¹è±¡è‡ªèº«çš„å±æ€§ï¼Œç­›æ‰å¯¹è±¡åŸå‹é“¾ä¸Šç»§æ‰¿çš„å±æ€§
        if (obj.hasOwnProperty(key)) {
            // å¦‚æœ obj[key] æ˜¯å¤æ‚æ•°æ®ç±»å‹ï¼Œé€’å½’
            cloneObj[key] = deepClone(obj[key], map);
        }
    }
    return cloneObj;
}
```

å†æ¬¡æ‰§è¡Œå‰é¢çš„ç”¨ä¾‹å¯ä»¥å‘ç°æ²¡æœ‰æŠ¥é”™ï¼Œå¾ªç¯å¼•ç”¨çš„é—®é¢˜è§£å†³äº†ã€‚

### ä½¿ç”¨ WeakMap ä¼˜åŒ–

ä¸‹é¢æˆ‘ä»¬ç”¨ `WeakMap` æ›¿ä»£ `Map` æ¥ä¼˜åŒ–æ·±æ‹·è´çš„å®ç°ã€‚

å¦‚ä¸‹ï¼š

```js
function deepClone(obj, map = new WeakMap()) {
    // ...
};
```

ä¸ºä»€ä¹ˆè¦è¿™æ ·åšå‘¢ï¼Ÿå…ˆæ¥çœ‹çœ‹ `WeakMap` çš„ä½œç”¨ï¼š

> WeakMap å¯¹è±¡æ˜¯ä¸€ç»„é”®/å€¼å¯¹çš„é›†åˆï¼Œå…¶ä¸­çš„é”®æ˜¯å¼±å¼•ç”¨çš„ã€‚å…¶é”®å¿…é¡»æ˜¯å¯¹è±¡ï¼Œè€Œå€¼å¯ä»¥æ˜¯ä»»æ„çš„ã€‚

ä»€ä¹ˆæ˜¯å¼±å¼•ç”¨å‘¢ï¼Ÿ

> åœ¨è®¡ç®—æœºç¨‹åºè®¾è®¡ä¸­ï¼Œå¼±å¼•ç”¨ä¸å¼ºå¼•ç”¨ç›¸å¯¹ï¼Œæ˜¯æŒ‡ä¸èƒ½ç¡®ä¿å…¶å¼•ç”¨çš„å¯¹è±¡ä¸ä¼šè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶çš„å¼•ç”¨ã€‚ ä¸€ä¸ªå¯¹è±¡è‹¥åªè¢«å¼±å¼•ç”¨æ‰€å¼•ç”¨ï¼Œåˆ™è¢«è®¤ä¸ºæ˜¯ä¸å¯è®¿é—®ï¼ˆæˆ–å¼±å¯è®¿é—®ï¼‰çš„ï¼Œå¹¶å› æ­¤å¯èƒ½åœ¨ä»»ä½•æ—¶åˆ»è¢«å›æ”¶ã€‚

æˆ‘ä»¬é»˜è®¤åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼š`const obj = {}`ï¼Œå°±é»˜è®¤åˆ›å»ºäº†ä¸€ä¸ªå¼ºå¼•ç”¨çš„å¯¹è±¡ï¼Œæˆ‘ä»¬åªæœ‰æ‰‹åŠ¨å°† `obj = null`ï¼Œå®ƒæ‰ä¼šè¢«åƒåœ¾å›æ”¶æœºåˆ¶è¿›è¡Œå›æ”¶ï¼Œå¦‚æœæ˜¯å¼±å¼•ç”¨å¯¹è±¡ï¼Œåƒåœ¾å›æ”¶æœºåˆ¶ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å›æ”¶ã€‚

ä¸¾ä¸ªä¾‹å­ï¼š

å¦‚æœæˆ‘ä»¬ä½¿ç”¨ `Map` çš„è¯ï¼Œé‚£ä¹ˆå¯¹è±¡é—´æ˜¯å­˜åœ¨å¼ºå¼•ç”¨å…³ç³»çš„ï¼š

```js
let obj = { name : 'Jack'}
const target = new Map();
target.set(obj,'person');
obj = null;
```

è™½ç„¶æˆ‘ä»¬æ‰‹åŠ¨å°† `obj`ï¼Œè¿›è¡Œé‡Šæ”¾ï¼Œç„¶æ˜¯ `target` ä¾ç„¶å¯¹ `obj` å­˜åœ¨å¼ºå¼•ç”¨å…³ç³»ï¼Œæ‰€ä»¥è¿™éƒ¨åˆ†å†…å­˜ä¾ç„¶æ— æ³•è¢«é‡Šæ”¾ã€‚

å†æ¥çœ‹ `WeakMap`ï¼š

```js
let obj = { name : 'Jack'}
const target = new WeakMap();
target.set(obj,'person');
obj = null;
```

å¦‚æœæ˜¯ `WeakMap` çš„è¯ï¼Œ`target` å’Œ `obj` å­˜åœ¨çš„å°±æ˜¯å¼±å¼•ç”¨å…³ç³»ï¼Œå½“ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶æœºåˆ¶æ‰§è¡Œæ—¶ï¼Œè¿™å—å†…å­˜å°±ä¼šè¢«é‡Šæ”¾æ‰ã€‚

è®¾æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬è¦æ‹·è´çš„å¯¹è±¡éå¸¸åºå¤§æ—¶ï¼Œä½¿ç”¨ `Map` ä¼šå¯¹å†…å­˜é€ æˆéå¸¸å¤§çš„é¢å¤–æ¶ˆè€—ï¼Œè€Œä¸”æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ¸…é™¤ `Map` çš„å±æ€§æ‰èƒ½é‡Šæ”¾è¿™å—å†…å­˜ï¼Œè€Œ `WeakMap` ä¼šå¸®æˆ‘ä»¬å·§å¦™åŒ–è§£è¿™ä¸ªé—®é¢˜ã€‚

æˆ‘ä¹Ÿç»å¸¸åœ¨æŸäº›ä»£ç ä¸­çœ‹åˆ°æœ‰äººä½¿ç”¨ `WeakMap` æ¥è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œä½†æ˜¯è§£é‡Šéƒ½æ˜¯æ¨¡æ£±ä¸¤å¯çš„ï¼Œå½“ä½ ä¸å¤ªäº†è§£ `WeakMap` çš„çœŸæ­£ä½œç”¨æ—¶ã€‚æˆ‘å»ºè®®ä½ ä¹Ÿä¸è¦åœ¨é¢è¯•ä¸­å†™è¿™æ ·çš„ä»£ç ï¼Œç»“æœåªèƒ½æ˜¯ç»™è‡ªå·±æŒ–å‘ï¼Œå³ä½¿æ˜¯å‡†å¤‡é¢è¯•ï¼Œä½ å†™çš„æ¯ä¸€è¡Œä»£ç ä¹Ÿéƒ½æ˜¯éœ€è¦ç»è¿‡æ·±æ€ç†Ÿè™‘å¹¶ä¸”éå¸¸æ˜ç™½çš„ã€‚

èƒ½è€ƒè™‘åˆ°å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œä½ å·²ç»å‘é¢è¯•å®˜å±•ç¤ºäº†ä½ è€ƒè™‘é—®é¢˜çš„å…¨é¢æ€§ï¼Œå¦‚æœè¿˜èƒ½ç”¨ `WeakMap` è§£å†³é—®é¢˜ï¼Œå¹¶å¾ˆæ˜ç¡®çš„å‘é¢è¯•å®˜è§£é‡Šè¿™æ ·åšçš„ç›®çš„ï¼Œé‚£ä¹ˆä½ çš„ä»£ç åœ¨é¢è¯•å®˜çœ¼é‡Œåº”è¯¥ç®—æ˜¯åˆæ ¼äº†ã€‚

- å¾ªç¯å¼•ç”¨éƒ¨åˆ†å†…å®¹å‡ºè‡ª `ConardLiå¤§ä½¬` [å¦‚ä½•å†™å‡ºä¸€ä¸ªæƒŠè‰³é¢è¯•å®˜çš„æ·±æ‹·è´?](https://link.juejin.cn/?target=https%3A%2F%2Fsegmentfault.com%2Fa%2F1190000020255831)ã€‚

## structuredClone() 

`Window`æ¥å£çš„ **`structuredClone()`** æ–¹æ³•ä½¿ç”¨[ç»“æ„åŒ–å…‹éš†ç®—æ³•](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Structured_clone_algorithm)å°†ç»™å®šçš„å€¼è¿›è¡Œæ·±æ‹·è´ã€‚

è¯¥æ–¹æ³•è¿˜æ”¯æŒæŠŠåŸå€¼ä¸­çš„[å¯è½¬ç§»å¯¹è±¡](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Transferable_objects)*è½¬ç§»*ï¼ˆè€Œä¸æ˜¯æ‹·è´ï¼‰åˆ°æ–°å¯¹è±¡ä¸Šã€‚å¯è½¬ç§»å¯¹è±¡ä¸åŸå§‹å¯¹è±¡åˆ†ç¦»å¹¶é™„åŠ åˆ°æ–°å¯¹è±¡ï¼›å®ƒä»¬å°†æ— æ³•åœ¨åŸå§‹å¯¹è±¡ä¸­è¢«è®¿é—®ã€‚

### ç»“æ„åŒ–å…‹éš†ç®—æ³•

**ç»“æ„åŒ–å…‹éš†ç®—æ³•**ç”¨äºå¤åˆ¶å¤æ‚ JavaScript å¯¹è±¡çš„ç®—æ³•ã€‚é€šè¿‡æ¥è‡ª Workerçš„ `postMessage()` æˆ–ä½¿ç”¨ IndexedDB å­˜å‚¨å¯¹è±¡æ—¶åœ¨å†…éƒ¨ä½¿ç”¨ã€‚å®ƒé€šè¿‡é€’å½’è¾“å…¥å¯¹è±¡æ¥æ„å»ºå…‹éš†ï¼ŒåŒæ—¶ä¿æŒå…ˆå‰è®¿é—®è¿‡çš„å¼•ç”¨çš„æ˜ å°„ï¼Œä»¥é¿å…æ— é™éå†å¾ªç¯ã€‚

> ç»“æ„åŒ–å…‹éš†æ‰€ä¸èƒ½åšåˆ°çš„
>
> - `Function`å¯¹è±¡æ˜¯ä¸èƒ½è¢«ç»“æ„åŒ–å…‹éš†ç®—æ³•å¤åˆ¶çš„ï¼›å¦‚æœä½ å°è¯•è¿™æ ·å­å»åšï¼Œè¿™ä¼šå¯¼è‡´æŠ›å‡º `DATA_CLONE_ERR` çš„å¼‚å¸¸ã€‚
> - ä¼å›¾å»å…‹éš† DOM èŠ‚ç‚¹åŒæ ·ä¼šæŠ›å‡º `DATA_CLONE_ERR` å¼‚å¸¸ã€‚
> - å¯¹è±¡çš„æŸäº›ç‰¹å®šå‚æ•°ä¹Ÿä¸ä¼šè¢«ä¿ç•™
>   - `RegExp` å¯¹è±¡çš„ `lastIndex` å­—æ®µä¸ä¼šè¢«ä¿ç•™
>   - å±æ€§æè¿°ç¬¦ï¼Œsetters ä»¥åŠ gettersï¼ˆä»¥åŠå…¶ä»–ç±»ä¼¼å…ƒæ•°æ®çš„åŠŸèƒ½ï¼‰åŒæ ·ä¸ä¼šè¢«å¤åˆ¶ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡ç”¨å±æ€§æè¿°ç¬¦æ ‡è®°ä¸º read-onlyï¼Œå®ƒå°†ä¼šè¢«å¤åˆ¶ä¸º read-writeï¼Œå› ä¸ºè¿™æ˜¯é»˜è®¤çš„æƒ…å†µä¸‹ã€‚
>   - åŸå½¢é“¾ä¸Šçš„å±æ€§ä¹Ÿä¸ä¼šè¢«è¿½è¸ªä»¥åŠå¤åˆ¶ã€‚

#### æ”¯æŒçš„ç±»å‹



##### JavaScript ç±»å‹

- `Array`
- `ArrayBuffer`
- `DataView`
- `Date`
- `Error`ç±»å‹ï¼ˆä»…é™éƒ¨åˆ† Error ç±»å‹)ï¼‰ã€‚
- `Map`
- `Object`å¯¹è±¡ï¼šä»…é™ç®€å•å¯¹è±¡ï¼ˆå¦‚ä½¿ç”¨å¯¹è±¡å­—é¢é‡åˆ›å»ºçš„ï¼‰ã€‚
- é™¤ `symbol` ä»¥å¤–çš„åŸºæœ¬ç±»å‹ã€‚
- `RegExp`ï¼š`lastIndex` å­—æ®µä¸ä¼šè¢«ä¿ç•™ã€‚
- `Set`
- `String`
- `TypedArray`

#### ä¸æ”¯æŒçš„ç±»å‹

##### å‡½æ•°

- å‡½æ•°åŒ…å«æ‰§è¡Œç¯å¢ƒï¼ˆé—­åŒ…ä¸Šä¸‹æ–‡ï¼‰ï¼Œè¿™äº›ç¯å¢ƒæ— æ³•åºåˆ—åŒ–ã€‚
- å…‹éš†åæ— æ³•æ¢å¤åŸå§‹ä½œç”¨åŸŸé“¾ã€‚
- å‡½æ•°å¯èƒ½å¼•ç”¨å¤–éƒ¨å˜é‡ï¼Œè€Œè¿™äº›å¼•ç”¨åœ¨æ–°ç¯å¢ƒä¸­æ— æ³•è¿˜åŸã€‚

##### DOMå…ƒç´ 

- DOM å…ƒç´ ä¾èµ–æµè§ˆå™¨çš„æ¸²æŸ“ä¸Šä¸‹æ–‡ã€‚
- å…ƒç´ åŒ…å«äº‹ä»¶ç›‘å¬å™¨ã€æ ·å¼ã€çŠ¶æ€ã€èŠ‚ç‚¹æ ‘ç­‰å¤æ‚ç»“æ„ï¼Œä¸èƒ½ç”¨æ™®é€š JS è¡¨è¾¾ã€‚
- DOM æ˜¯æµè§ˆå™¨å†…éƒ¨çš„å®¿ä¸»å¯¹è±¡ï¼Œä¸æ˜¯çº¯ JS å¯¹è±¡ã€‚

##### Proxy

- Proxy æœ¬è´¨æ˜¯åŠ¨æ€è¡Œä¸ºçš„ä»£ç†ï¼Œå®ƒä¸æ˜¯æ•°æ®ï¼Œè€Œæ˜¯ä¸€ç§ **è¡Œä¸ºåŒ…è£…å™¨**ã€‚
- å†…éƒ¨çš„ handlerï¼ˆä»£ç†å¯¹è±¡ï¼‰åŒ…å«ä¸å¯è§çš„è¡Œä¸ºé€»è¾‘ï¼ŒstructuredClone æ— æ³•å¤åŸã€‚
- å…‹éš†åå³ä½¿å¼ºè¡Œå¤åˆ¶ï¼Œè¡Œä¸ºå¯èƒ½å®Œå…¨ä¸åŒã€‚

#####  Error å­ç±»

- Error å¯¹è±¡åŒ…å« stack traceï¼ˆå †æ ˆä¿¡æ¯ï¼‰ã€message ç­‰ä¸è¿è¡Œæ—¶ç´§å¯†ç»‘å®šçš„å†…å®¹ã€‚
- è™½ç„¶æœ‰çš„æµè§ˆå™¨æ”¯æŒéƒ¨åˆ† `Error` å…‹éš†ï¼Œä½†å¹¶ä¸æ˜¯è§„èŒƒå¼ºåˆ¶è¦æ±‚ã€‚

> å®é™…ä¸Šï¼Œæ‰€æœ‰æ·±æ‹·è´éƒ½ä¸èƒ½å®Œç¾è§£å†³ä»¥ä¸Šç±»å‹ã€‚

## Lodash.cloneDeep()

`Lodash` å®ç°äº†å‡½æ•°ã€æ­£åˆ™ã€Dateã€Bufferã€Mapã€Setã€åŸå‹é“¾ç­‰æƒ…å†µä¸‹çš„æ·±æ‹·è´ã€‚

### å…¥å£

å…¥å£æ–‡ä»¶æ˜¯ `cloneDeep.js`ï¼Œç›´æ¥è°ƒç”¨æ ¸å¿ƒæ–‡ä»¶ `baseClone.js` çš„æ–¹æ³•ã€‚

> `baseClone` å…³è”äº†å¤šç§ clone æ–¹æ³•ï¼Œå¦‚ `clone`ï¼Œ`cloneWith`,  `cloneDeep`ï¼Œ`cloneDeepWith`ç­‰

```js
const CLONE_DEEP_FLAG = 1
const CLONE_SYMBOLS_FLAG = 4

function cloneDeep(value) {
    return baseClone(value, CLONE_DEEP_FLAG | CLONE_SYMBOLS_FLAG)
}
```

ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯éœ€è¦æ‹·è´çš„å¯¹è±¡ï¼Œç¬¬äºŒä¸ªæ˜¯ä½æ©ç ï¼ˆBitwiseï¼‰ï¼Œå…³äºä½æ©ç çš„è¯¦ç»†ä»‹ç»è¯·çœ‹ä¸‹é¢æ‹“å±•éƒ¨åˆ†ã€‚

### baseClone æ–¹æ³•

ç„¶åæˆ‘ä»¬è¿›å…¥ `baseClone.js` æŸ¥çœ‹å…·ä½“æ–¹æ³•ï¼Œä¸»è¦å®ç°é€»è¾‘éƒ½åœ¨è¿™ä¸ªæ–¹æ³•é‡Œã€‚

å…ˆä»‹ç»ä¸‹è¯¥æ–¹æ³•çš„å‚æ•° `baseClone(value, bitmask, customizer, key, object, stack)`

- åˆå§‹åŒ–éœ€è¦çš„æ•°æ®ï¼š

  `value`ï¼šå­—ç¬¦ä¸²ï¼Œæ•°å­—ï¼Œå¯¹è±¡ï¼Œæ•°ç»„ï¼Œå‡½æ•°

  `bitmask`ï¼šä½æ©ç ï¼Œå…¶ä¸­ 1 æ˜¯æ·±æ‹·è´ï¼Œ2 æ‹·è´åŸå‹é“¾ä¸Šçš„å±æ€§ï¼Œ4 æ˜¯æ‹·è´ Symbols å±æ€§

  `customizer`ï¼šå®šåˆ¶çš„ `clone` å‡½æ•° **ï¼ˆè¿™ä¸ªæ˜¯ç»™ `cloneWith` å‡½æ•°ç”¨çš„ï¼Œä¸æœ¬æ–‡æ— å…³ï¼‰**

- é€’å½’ä¸­éœ€è¦çš„æ•°æ®ï¼š

  `value`ï¼šå­—ç¬¦ä¸²ï¼Œæ•°å­—ï¼Œå¯¹è±¡ï¼Œæ•°ç»„ï¼Œå‡½æ•°

  `key`ï¼šå­—ç¬¦ä¸²ï¼Œæ•°å­—æˆ– Symbol

  `object` ï¼šçˆ¶å¯¹è±¡

  `stack`ï¼šStack æ ˆï¼Œç”¨æ¥å¤„ç†å¾ªç¯å¼•ç”¨

  `customizer`ï¼šå®šåˆ¶çš„ `clone` å‡½æ•°

æˆ‘å°†åˆ†æˆä»¥ä¸‹å‡ éƒ¨åˆ†è¿›è¡Œè®²è§£ï¼Œå¯ä»¥é€‰æ‹©è‡ªå·±æ„Ÿå…´è¶£çš„éƒ¨åˆ†é˜…è¯»ã€‚

- ä½æ©ç 
- å®šåˆ¶ `clone` å‡½æ•°
- åŸºæœ¬æ•°æ®ç±»å‹
- æ•°ç»„ & æ­£åˆ™
- å¯¹è±¡ & å‡½æ•°
- å¾ªç¯å¼•ç”¨
- Map & Set
- Symbol & åŸå‹é“¾

### ä½æ©ç 

ä¸Šé¢ç®€å•ä»‹ç»äº†ä½æ©ç ï¼Œå‚æ•°å®šä¹‰å¦‚ä¸‹ã€‚

```js
// ä¸»çº¿ä»£ç 
const CLONE_DEEP_FLAG = 1		// 1 å³ 0001ï¼Œæ·±æ‹·è´æ ‡å¿—ä½
const CLONE_FLAT_FLAG = 2		// 2 å³ 0010ï¼Œæ‹·è´åŸå‹é“¾æ ‡å¿—ä½ï¼Œ
const CLONE_SYMBOLS_FLAG = 4	// 4 å³ 0100ï¼Œæ‹·è´ Symbols æ ‡å¿—ä½
```

ä½æ©ç ç”¨äºå¤„ç†åŒæ—¶å­˜åœ¨å¤šä¸ªå¸ƒå°”é€‰é¡¹çš„æƒ…å†µï¼Œå…¶ä¸­**æ©ç ä¸­çš„æ¯ä¸ªé€‰é¡¹çš„å€¼éƒ½ç­‰äº 2 çš„å¹‚**ã€‚ç›¸æ¯”ç›´æ¥ä½¿ç”¨å˜é‡æ¥è¯´ï¼Œä¼˜ç‚¹æ˜¯å¯ä»¥èŠ‚çœå†…å­˜

> äººè¯ï¼šåŸæœ¬æ˜¯ç”¨å¸ƒå°”å€¼ï¼ˆtrue/falseï¼‰å­˜å‚¨çŠ¶æ€çš„ï¼Œç°åœ¨ç”¨äºŒè¿›åˆ¶æ¥ä»£æ›¿äº†
>
> ```js
> // ä½æ©ç æ–¹å¼
> flags = 0b0101; // è¡¨ç¤ºç¬¬0ä½å’Œç¬¬2ä½ä¸ºtrue
> 
> // å¸ƒå°”æ–¹å¼
> flag1 = true;
> flag2 = false;
> flag3 = true;
> ```
>
> è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ²¡æœ‰3ï¼Œå› ä¸º3æ˜¯011ï¼Œæœ‰ä¸¤ä½1ï¼Œå†åç»­æ¯ä½ä¹Ÿæ˜¯ 2 çš„å¹‚ï¼Œå¦‚8ä¸º1000

```js
// cloneDeep.js æ·»åŠ æ ‡å¿—ä½ï¼Œ1 | 4 å³ 0001 | 0100 å³ 0101 å³ 5
CLONE_DEEP_FLAG | CLONE_SYMBOLS_FLAG

// ä¸»çº¿ä»£ç 
// baseClone.js å–å‡ºæ ‡å¿—ä½
let result // åˆå§‹åŒ–è¿”å›ç»“æœï¼Œåç»­ä»£ç éœ€è¦ï¼Œå’Œä½æ©ç æ— å…³
const isDeep = bitmask & CLONE_DEEP_FLAG 	// 5 & 1 å³ 1 å³ true
const isFlat = bitmask & CLONE_FLAT_FLAG	// 5 & 2 å³ 0 å³ false
const isFull = bitmask & CLONE_SYMBOLS_FLAG // 5 & 4 å³ 4 å³ true
```

### å®šåˆ¶ `clone` å‡½æ•°

ç”¨äº `cloneWith` å‡½æ•°

``` js
// ä¸»çº¿ä»£ç 
// åˆ¤æ–­æ˜¯å¦ä¼ å…¥customizerå‡½æ•°
if (customizer) {
    result = object ? customizer(value, key, object, stack) : customizer(value);
}
if (result !== undefined) {
    return result;
}
```

### åŸºæœ¬æ•°æ®ç±»å‹

éå¯¹è±¡çš„å°±æ˜¯åŸºæœ¬æ•°æ®ç±»å‹ï¼Œåˆ¤æ–­è¦æ‹·è´çš„å€¼æ˜¯å¦æ˜¯å¯¹è±¡ï¼Œéå¯¹è±¡ç›´æ¥è¿”å›æœ¬æ¥çš„å€¼

> `function` ä¹Ÿæ˜¯å¯¹è±¡

```js
// ä¸»çº¿ä»£ç 
if (!isObject(value)) {
    return value;
}

function isObject(value) {
    const type = typeof value;
    return value != null && (type == 'object' || type ='function');// éç©º å‡½æ•° å¯¹è±¡
}
```

åˆ¤æ–­å®ŒåŸºç¡€æ•°æ®ç±»å‹åå°±åªå‰©ä¸‹æ•°ç»„å’Œå¯¹è±¡äº†

### æ•°ç»„ ï¼† æ­£åˆ™

```js
// ä¸»çº¿ä»£ç 
const isArr = Array.isArray(value)
const hasOwnProperty = Object.prototype.hasOwnProperty

// åˆ¤æ–­æ•°ç»„
if (isArr) {
    result = initCloneArray(value)
    if (!isDeep) {
		return copyArray(value, result)
	}
} else {
    // éæ•°ç»„ï¼Œåé¢è§£æ
}

// åˆå§‹åŒ–ä¸€ä¸ªæ•°ç»„
function initCloneArray(array) {
  	const { length } = array
    // æ„é€ ç›¸åŒé•¿åº¦çš„æ–°æ•°ç»„
  	const result = new array.constructor(length)

  	// æ­£åˆ™ `RegExp#exec` è¿”å›çš„æ•°ç»„
  	if (length && typeof array[0] == 'string' && hasOwnProperty.call(array, 'index')) {
   	 	result.index = array.index
    	result.input = array.input
  	}
  	return result
}

// ... æœªå®Œå¾…ç»­ï¼Œæœ€åéƒ¨åˆ†æœ‰æ•°ç»„éå†èµ‹å€¼  
```

ä¼ å…¥çš„å¯¹è±¡æ˜¯æ•°ç»„æ—¶ï¼Œæ„é€ ä¸€ä¸ªç›¸åŒé•¿åº¦çš„æ•°ç»„ `new array.constructor(length)`ï¼Œè¿™é‡Œç›¸å½“äº `new Array(length)`ï¼Œå› ä¸º `array.constructor === Array`ã€‚

```js
var a = [];
a.constructor === Array; // true

var a = new Array;
a.constructor === Array // true
```

å¦‚æœå­˜åœ¨æ­£åˆ™ `RegExp#exec` è¿”å›çš„æ•°ç»„ï¼Œæ‹·è´å±æ€§ `index` å’Œ `input`ã€‚åˆ¤æ–­é€»è¾‘æ˜¯ 1ã€æ•°ç»„é•¿åº¦å¤§äº 0ï¼Œ2ã€æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œ3ã€æ•°ç»„å­˜åœ¨ `index` å±æ€§ã€‚

```js
if (length && typeof array[0] == 'string' && hasOwnProperty.call(array, 'index')) {
    result.index = array.index
    result.input = array.input
}
```

å…¶ä¸­æ­£åˆ™è¡¨è¾¾å¼ `regexObj.exec(str)` åŒ¹é…æˆåŠŸæ—¶ï¼Œè¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œå¹¶æ›´æ–°æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡çš„å±æ€§ã€‚è¿”å›çš„æ•°ç»„å°†å®Œå…¨åŒ¹é…æˆåŠŸçš„æ–‡æœ¬ä½œä¸ºç¬¬ä¸€é¡¹ï¼Œå°†æ­£åˆ™æ‹¬å·é‡ŒåŒ¹é…æˆåŠŸçš„ä½œä¸ºæ•°ç»„å¡«å……åˆ°åé¢ã€‚åŒ¹é…å¤±è´¥æ—¶è¿”å› `null`ã€‚

```js
var re = /quick\s(brown).+?(jumps)/ig;
var result = re.exec('The Quick Brown Fox Jumps Over The Lazy Dog');
console.log(result);
// [
//	0: "Quick Brown Fox Jumps" 	// åŒ¹é…çš„å…¨éƒ¨å­—ç¬¦ä¸²
//	1: "Brown"					// æ‹¬å·ä¸­çš„åˆ†ç»„æ•è·
//	2: "Jumps"
//	groups: undefined
//	index: 4					// åŒ¹é…åˆ°çš„å­—ç¬¦ä½äºåŸå§‹å­—ç¬¦ä¸²çš„åŸºäº0çš„ç´¢å¼•å€¼
//	input: "The Quick Brown Fox Jumps Over The Lazy Dog" // åŸå§‹å­—ç¬¦ä¸²
//	length: 3
// ]
```

å¦‚æœä¸æ˜¯æ·±æ‹·è´ï¼Œä¼ å…¥`value` å’Œ `result`ï¼Œç›´æ¥è¿”å›æµ…æ‹·è´åçš„æ•°ç»„ã€‚è¿™é‡Œçš„æµ…æ‹·è´æ–¹å¼å°±æ˜¯å¾ªç¯ç„¶åå¤åˆ¶ã€‚

```js
if (!isDeep) {
	return copyArray(value, result)
}

// æµ…æ‹·è´æ•°ç»„
function copyArray(source, array) {
  let index = -1
  const length = source.length
  array || (array = new Array(length))
  while (++index < length) {
    array[index] = source[index]
  }
  return array
}
```

### å¯¹è±¡ï¼†å‡½æ•°

```js
// ä¸»çº¿ä»£ç 
const isArr = Array.isArray(value)
const tag = getTag(value)
if (isArr) {
    ... // æ•°ç»„æƒ…å†µï¼Œè¯¦è§ä¸Šé¢è§£æ
} else {
    // å‡½æ•°
    const isFunc = typeof value == 'function'

    // å¦‚æœæ˜¯ Buffer å¯¹è±¡ï¼Œæ‹·è´å¹¶è¿”å›
    if (isBuffer(value)) {
        return cloneBuffer(value, isDeep)
    }
    
    // Object å¯¹è±¡ã€ç±»æ•°ç»„ã€æˆ–è€…æ˜¯å‡½æ•°ä½†æ²¡æœ‰çˆ¶å¯¹è±¡
    if (tag == objectTag || tag == argsTag || (isFunc && !object)) {
        // æ‹·è´åŸå‹é“¾æˆ–è€… value æ˜¯å‡½æ•°æ—¶ï¼Œè¿”å› {}ï¼Œä¸ç„¶åˆå§‹åŒ–å¯¹è±¡
        result = (isFlat || isFunc) ? {} : initCloneObject(value)
        if (!isDeep) {
            return isFlat
                ? copySymbolsIn(value, copyObject(value, keysIn(value), result))
            	: copySymbols(value, Object.assign(result, value))
        }
    } else {
        // åœ¨ cloneableTags ä¸­ï¼Œåªæœ‰ error å’Œ weakmap è¿”å› false
        // å‡½æ•°æˆ–è€… error æˆ–è€… weakmap æ—¶ï¼Œ
        if (isFunc || !cloneableTags[tag]) {
            // å­˜åœ¨çˆ¶å¯¹è±¡è¿”å›valueï¼Œä¸ç„¶è¿”å›ç©ºå¯¹è±¡ {}
            return object ? value : {}
        }
        // åˆå§‹åŒ–éå¸¸è§„ç±»å‹
        result = initCloneByTag(value, tag, isDeep)
    }
}
```

é€šè¿‡ä¸Šé¢ä»£ç å¯ä»¥å‘ç°ï¼Œå‡½æ•°ã€`error` å’Œ `weakmap` æ—¶è¿”å›ç©ºå¯¹è±¡ {}ï¼Œå¹¶ä¸ä¼šçœŸæ­£æ‹·è´å‡½æ•°ã€‚

`value` ç±»å‹æ˜¯ `Object` å¯¹è±¡å’Œç±»æ•°ç»„æ—¶ï¼Œè°ƒç”¨ `initCloneObject` åˆå§‹åŒ–å¯¹è±¡ï¼Œæœ€ç»ˆè°ƒç”¨ `Object.create` ç”Ÿæˆæ–°å¯¹è±¡ã€‚

```js
function initCloneObject(object) {
    // æ„é€ å‡½æ•°å¹¶ä¸”è‡ªå·±ä¸åœ¨è‡ªå·±çš„åŸå‹é“¾ä¸Š
    return (typeof object.constructor == 'function' && !isPrototype(object))
        ? Object.create(Object.getPrototypeOf(object))
    	: {}
}

// æœ¬è´¨ä¸Šå®ç°äº†ä¸€ä¸ªinstanceofï¼Œç”¨æ¥æµ‹è¯•è‡ªå·±æ˜¯å¦åœ¨è‡ªå·±çš„åŸå‹é“¾ä¸Š
function isPrototype(value) {
    const Ctor = value && value.constructor
    // å¯»æ‰¾å¯¹åº”åŸå‹
    const proto = (typeof Ctor == 'function' && Ctor.prototype) || Object.prototype
    return value === proto
}
```

å…¶ä¸­ `Object` çš„æ„é€ å‡½æ•°æ˜¯ä¸€ä¸ªå‡½æ•°å¯¹è±¡ã€‚

```js
var obj = new Object();
typeof obj.constructor; 
// 'function'

var obj2 = {};
typeof obj2.constructor;
// 'function'
```

å¯¹äºéå¸¸è§„ç±»å‹å¯¹è±¡ï¼Œé€šè¿‡å„è‡ªç±»å‹åˆ†åˆ«è¿›è¡Œåˆå§‹åŒ–ã€‚

```js
function initCloneByTag(object, tag, isDeep) {
    const Ctor = object.constructor
    switch (tag) {
        case arrayBufferTag:
            return cloneArrayBuffer(object)

        case boolTag: // å¸ƒå°”ä¸æ—¶é—´ç±»å‹
        case dateTag:
            return new Ctor(+object) // + è½¬æ¢ä¸ºæ•°å­—

        case dataViewTag:
            return cloneDataView(object, isDeep)

        case float32Tag: case float64Tag:
        case int8Tag: case int16Tag: case int32Tag:
        case uint8Tag: case uint8ClampedTag: case uint16Tag: case uint32Tag:
            return cloneTypedArray(object, isDeep)

        case mapTag: // Map ç±»å‹
            return new Ctor

        case numberTag: // æ•°å­—å’Œå­—ç¬¦ä¸²ç±»å‹
        case stringTag:
            return new Ctor(object)

        case regexpTag: // æ­£åˆ™
            return cloneRegExp(object)

        case setTag: // Set ç±»å‹
            return new Ctor

        case symbolTag: // Symbol ç±»å‹
            return cloneSymbol(object)
    }
}
```

æ‹·è´æ­£åˆ™ç±»å‹

```js
// \w ç”¨äºåŒ¹é…å­—æ¯ï¼Œæ•°å­—æˆ–ä¸‹åˆ’çº¿å­—ç¬¦ï¼Œç›¸å½“äº[A-Za-z0-9_]
const reFlags = /\w*$/
function cloneRegExp(regexp) {
    // è¿”å›å½“å‰åŒ¹é…çš„æ–‡æœ¬
    const result = new regexp.constructor(regexp.source, reFlags.exec(regexp))
    // ä¸‹ä¸€æ¬¡åŒ¹é…çš„èµ·å§‹ç´¢å¼•
    result.lastIndex = regexp.lastIndex
    return result
}
```

åˆå§‹åŒ– `Symbol` ç±»å‹

```js
const symbolValueOf = Symbol.prototype.valueOf
function cloneSymbol(symbol) {
    return Object(symbolValueOf.call(symbol))
}
```

### å¾ªç¯å¼•ç”¨

æ„é€ äº†ä¸€ä¸ªæ ˆç”¨æ¥è§£å†³å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚

```js
// ä¸»çº¿ä»£ç 
stack || (stack = new Stack)
const stacked = stack.get(value)
// å·²å­˜åœ¨
if (stacked) {
    return stacked
}
stack.set(value, result)
```

å¦‚æœå½“å‰éœ€è¦æ‹·è´çš„å€¼å·²å­˜åœ¨äºæ ˆä¸­ï¼Œè¯´æ˜æœ‰ç¯ï¼Œç›´æ¥è¿”å›å³å¯ã€‚æ ˆä¸­æ²¡æœ‰è¯¥å€¼æ—¶ä¿å­˜åˆ°æ ˆä¸­ï¼Œä¼ å…¥ `value` å’Œ `result`ã€‚è¿™é‡Œçš„ `result` æ˜¯ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œåç»­å¯¹ `result` çš„ä¿®æ”¹ä¹Ÿä¼šååº”åˆ°æ ˆä¸­ã€‚

### Map & Set

`value` å€¼æ˜¯ `Map` ç±»å‹æ—¶ï¼Œéå† `value` å¹¶é€’å½’å…¶ `subValue`ï¼Œéå†å®Œæˆè¿”å› `result` ç»“æœã€‚

```js
// ä¸»çº¿ä»£ç 
if (tag == mapTag) {
    value.forEach((subValue, key) => {
        result.set(key, baseClone(subValue, bitmask, customizer, key, value, stack))
    })
    return result
}
```

`value` å€¼æ˜¯ `Set` ç±»å‹æ—¶ï¼Œéå† `value` å¹¶é€’å½’å…¶ `subValue`ï¼Œéå†å®Œæˆè¿”å› `result` ç»“æœã€‚

```js
// ä¸»çº¿ä»£ç 
if (tag == setTag) {
    value.forEach((subValue) => {
        result.add(baseClone(subValue, bitmask, customizer, subValue, value, stack))
    })
    return result
}
```

ä¸Šé¢çš„åŒºåˆ«åœ¨äºæ·»åŠ å…ƒç´ çš„ API ä¸åŒï¼Œå³ `Map.set` å’Œ `Set.add`ã€‚

### Symbol & åŸå‹é“¾

è¿™é‡Œæˆ‘ä»¬ä»‹ç»ä¸‹ `Symbol` å’Œ åŸå‹é“¾å±æ€§çš„æ‹·è´ï¼Œé€šè¿‡æ ‡å¿—ä½ `isFull` å’Œ `isFlat` æ¥æ§åˆ¶æ˜¯å¦æ‹·è´ã€‚

```js
// ä¸»çº¿ä»£ç 
// ç±»å‹åŒ–æ•°ç»„å¯¹è±¡
if (isTypedArray(value)) {
    return result
}

const keysFunc = isFull // æ‹·è´ Symbol æ ‡å¿—ä½
	? (isFlat 			// æ‹·è´åŸå‹é“¾å±æ€§æ ‡å¿—ä½
       ? getAllKeysIn 	// åŒ…å«è‡ªèº«å’ŒåŸå‹é“¾ä¸Šå¯æšä¸¾å±æ€§åä»¥åŠ Symbol
       : getAllKeys)	// ä»…åŒ…å«è‡ªèº«å¯æšä¸¾å±æ€§åä»¥åŠ Symbol
	: (isFlat 
       ? keysIn 		// åŒ…å«è‡ªèº«å’ŒåŸå‹é“¾ä¸Šå¯æšä¸¾å±æ€§åçš„æ•°ç»„
       : keys)			// ä»…åŒ…å«è‡ªèº«å¯æšä¸¾å±æ€§åçš„æ•°ç»„

const props = isArr ? undefined : keysFunc(value)
arrayEach(props || value, (subValue, key) => {
    if (props) {
        key = subValue
        subValue = value[key]
    }
    // é€’å½’æ‹·è´ï¼ˆæ˜“å—è°ƒç”¨å †æ ˆé™åˆ¶ï¼‰
    assignValue(result, key, baseClone(subValue, bitmask, customizer, key, value, stack))
})
return result
```

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹æ€ä¹ˆè·å–è‡ªèº«ã€åŸå‹é“¾ã€Symbol è¿™å‡ ç§å±æ€§åç»„æˆçš„æ•°ç»„ `keys`ã€‚

```js
// åˆ›å»ºä¸€ä¸ªåŒ…å«è‡ªèº«å’ŒåŸå‹é“¾ä¸Šå¯æšä¸¾å±æ€§åä»¥åŠ Symbol çš„æ•°ç»„
// ä½¿ç”¨ for...in éå†
function getAllKeysIn(object) {
    const result = keysIn(object)
    if (!Array.isArray(object)) {
        result.push(...getSymbolsIn(object))
    }
    return result
}

// åˆ›å»ºä¸€ä¸ªä»…åŒ…å«è‡ªèº«å¯æšä¸¾å±æ€§åä»¥åŠ Symbol çš„æ•°ç»„
// é ArrayLike æ•°ç»„ä½¿ç”¨ Object.keys
function getAllKeys(object) {
    const result = keys(object)
    if (!Array.isArray(object)) {
        result.push(...getSymbols(object))
    }
    return result
}
```

ä¸Šé¢é€šè¿‡ `keysIn` å’Œ `keys` è·å–å¸¸è§„å¯æšä¸¾å±æ€§ï¼Œé€šè¿‡ `getSymbolsIn` å’Œ `getSymbols` è·å– `Symbol` å¯æšä¸¾å±æ€§ã€‚

```js
// åˆ›å»ºä¸€ä¸ªåŒ…å«è‡ªèº«å’ŒåŸå‹é“¾ä¸Šå¯æšä¸¾å±æ€§åçš„æ•°ç»„
// ä½¿ç”¨ for...in éå†
function keysIn(object) {
    const result = []
    for (const key in object) {
        result.push(key)
    }
    return result
}

// åˆ›å»ºä¸€ä¸ªä»…åŒ…å«è‡ªèº«å¯æšä¸¾å±æ€§åçš„æ•°ç»„
// é ArrayLike æ•°ç»„ä½¿ç”¨ Object.keys
function keys(object) {
    return isArrayLike(object)
        ? arrayLikeKeys(object)
    	: Object.keys(Object(object))
}

// æµ‹è¯•ä»£ç 
function Foo() {
  this.a = 1
  this.b = 2
}
Foo.prototype.c = 3

keysIn(new Foo)
// ['a', 'b', 'c'] (è¿­ä»£é¡ºåºæ— æ³•ä¿è¯)
     
keys(new Foo)
// ['a', 'b'] (è¿­ä»£é¡ºåºæ— æ³•ä¿è¯)
```

å¸¸è§„å±æ€§éå†åŸå‹é“¾ç”¨çš„æ˜¯ `for.. in`ï¼Œé‚£ä¹ˆ `Symbol` æ˜¯å¦‚ä½•éå†åŸå‹é“¾çš„å‘¢ï¼Œè¿™é‡Œé€šè¿‡å¾ªç¯ä»¥åŠä½¿ç”¨ `Object.getPrototypeOf` è·å–åŸå‹é“¾ä¸Šçš„ `Symbol`ã€‚

```js
// åˆ›å»ºä¸€ä¸ªåŒ…å«è‡ªèº«å’ŒåŸå‹é“¾ä¸Šå¯æšä¸¾ Symbol çš„æ•°ç»„
// é€šè¿‡å¾ªç¯å’Œä½¿ç”¨ Object.getPrototypeOf è·å–åŸå‹é“¾ä¸Šçš„ Symbol
function getSymbolsIn (object) {
    const result = []
    while (object) { // å¾ªç¯
        result.push(...getSymbols(object))
        object = Object.getPrototypeOf(Object(object))
    }
    return result
}

// åˆ›å»ºä¸€ä¸ªä»…åŒ…å«è‡ªèº«å¯æšä¸¾ Symbol çš„æ•°ç»„
// é€šè¿‡ Object.getOwnPropertySymbols è·å– Symbol å±æ€§
const nativeGetSymbols = Object.getOwnPropertySymbols
const propertyIsEnumerable = Object.prototype.propertyIsEnumerable

function getSymbols (object) {
    if (object == null) { // åˆ¤ç©º
        return []
    }
    object = Object(object)
    return nativeGetSymbols(object)
        .filter((symbol) => propertyIsEnumerable.call(object, symbol))
}
```

æˆ‘ä»¬å›åˆ°ä¸»çº¿ä»£ç ï¼Œè·å–åˆ° `keys` ç»„æˆçš„ `props` æ•°ç»„ä¹‹åï¼Œéå†å¹¶é€’å½’ã€‚

```js
// ä¸»çº¿ä»£ç 
const props = isArr ? undefined : keysFunc(value)
arrayEach(props || value, (subValue, key) => {
    // props æ—¶æ›¿æ¢ key å’Œ subValueï¼Œå› ä¸º props é‡Œé¢çš„ subValue åªæ˜¯ value çš„ key
    if (props) { 
        key = subValue
        subValue = value[key]
    }
    // é€’å½’æ‹·è´ï¼ˆæ˜“å—è°ƒç”¨å †æ ˆé™åˆ¶ï¼‰
    assignValue(result, key, baseClone(subValue, bitmask, customizer, key, value, stack))
})

// è¿”å›ç»“æœï¼Œä¸»çº¿ç»“æŸ
return result
```

æˆ‘ä»¬çœ‹ä¸‹ `arrayEach` çš„å®ç°ï¼Œä¸»è¦å®ç°äº†ä¸€ä¸ªéå†ï¼Œå¹¶åœ¨ `iteratee` è¿”å›ä¸º false æ—¶é€€å‡ºã€‚

```js
// è¿­ä»£æ•°ç»„
// iteratee æ˜¯æ¯æ¬¡è¿­ä»£è°ƒç”¨çš„å‡½æ•°
function arrayEach(array, iteratee) {
    let index = -1
    const length = array.length

    while (++index < length) {
        if (iteratee(array[index], index, array) === false) {
            break
        }
    }
    return array
}
```

æˆ‘ä»¬çœ‹ä¸‹ `assignValue` çš„å®ç°ï¼Œåœ¨å€¼ä¸ç›¸ç­‰æƒ…å†µä¸‹ï¼Œå°† value åˆ†é…ç»™ `object[key]`ã€‚

```js
const hasOwnProperty = Object.prototype.hasOwnProperty

// å¦‚æœç°æœ‰å€¼ä¸ç›¸ç­‰ï¼Œåˆ™å°† value åˆ†é…ç»™ object[key]ã€‚
function assignValue(object, key, value) {
    const objValue = object[key]

    // ä¸ç›¸ç­‰
    if (! (hasOwnProperty.call(object, key) && eq(objValue, value)) ) {
        // å€¼å¯ç”¨
        if (value !== 0 || (1 / value) == (1 / objValue)) {
            baseAssignValue(object, key, value)
        }
    // å€¼æœªå®šä¹‰è€Œä¸”é”® key ä¸åœ¨å¯¹è±¡ä¸­    
    } else if (value === undefined && !(key in object)) {
        baseAssignValue(object, key, value)
    }
}

// èµ‹å€¼åŸºæœ¬å®ç°ï¼Œå…¶ä¸­æ²¡æœ‰å€¼æ£€æŸ¥ã€‚
function baseAssignValue(object, key, value) {
    if (key == '__proto__') {
        Object.defineProperty(object, key, {
            'configurable': true,
            'enumerable': true,
            'value': value,
            'writable': true
        })
    } else {
        object[key] = value
    }
}

// æ¯”è¾ƒä¸¤ä¸ªå€¼æ˜¯å¦ç›¸ç­‰
// (value !== value && other !== other) æ˜¯ä¸ºäº†åˆ¤æ–­ NaN
function eq(value, other) {
  return value === other || (value !== value && other !== other)
}
```

### baseCloneå®Œæ•´ä»£ç 

è¿™éƒ¨åˆ†å°±æ˜¯æ ¸å¿ƒä»£ç äº†ï¼Œå„åŠŸèƒ½åˆ†å‰²å¦‚ä¸‹ï¼Œè¯¦ç»†åŠŸèƒ½å®ç°éƒ¨åˆ†å°†å¯¹å„ä¸ªåŠŸèƒ½è¯¦ç»†è§£è¯»ã€‚

```js
/**
* The base implementation of `_.clone` and `_.cloneDeep` which tracks
* traversed objects.
*
* @private
* @param {*} value The value to clone.
* @param {boolean} bitmask The bitmask flags.
*  1 - Deep clone
*  2 - Flatten inherited properties
*  4 - Clone symbols
* @param {Function} [customizer] The function to customize cloning.
* @param {string} [key] The key of `value`.
* @param {Object} [object] The parent object of `value`.
* @param {Object} [stack] Tracks traversed objects and their clone counterparts.
* @returns {*} Returns the cloned value.
*/

function baseClone(value, bitmask, customizer, key, object, stack) {
    let result

    // æ ‡å¿—ä½
    const isDeep = bitmask & CLONE_DEEP_FLAG		// æ·±æ‹·è´ï¼Œtrue
    const isFlat = bitmask & CLONE_FLAT_FLAG		// æ‹·è´åŸå‹é“¾ï¼Œfalse
    const isFull = bitmask & CLONE_SYMBOLS_FLAG	// æ‹·è´ Symbolï¼Œtrue

    // ä¸º cloneWith æ–¹æ³•æä¾›è‡ªå®šä¹‰ clone å‡½æ•°
    if (customizer) {
        result = object ? customizer(value, key, object, stack) : customizer(value)
    }
    if (result !== undefined) {
        return result
    }

    // éå¯¹è±¡  
    if (!isObject(value)) {
        return value
    }
    
    const isArr = Array.isArray(value)
    const tag = getTag(value)
    if (isArr) {
        // æ•°ç»„
        result = initCloneArray(value)
        if (!isDeep) {
            return copyArray(value, result)
        }
    } else {
        // å¯¹è±¡
        const isFunc = typeof value == 'function'

        if (isBuffer(value)) {
            return cloneBuffer(value, isDeep)
        }
        if (tag == objectTag || tag == argsTag || (isFunc && !object)) {
            result = (isFlat || isFunc) ? {} : initCloneObject(value)
            if (!isDeep) {
                return isFlat
                    ? copySymbolsIn(value, copyObject(value, keysIn(value), result))
                	: copySymbols(value, Object.assign(result, value))
            }
        } else {
            if (isFunc || !cloneableTags[tag]) {
                return object ? value : {}
            }
            result = initCloneByTag(value, tag, isDeep)
        }
    }
    // å¾ªç¯å¼•ç”¨
    stack || (stack = new Stack)
    const stacked = stack.get(value)
    if (stacked) {
        return stacked
    }
    stack.set(value, result)

    // Map
    if (tag == mapTag) {
        value.forEach((subValue, key) => {
            result.set(key, baseClone(subValue, bitmask, customizer, key, value, stack))
        })
        return result
    }

    // Set
    if (tag == setTag) {
        value.forEach((subValue) => {
            result.add(baseClone(subValue, bitmask, customizer, subValue, value, stack))
        })
        return result
    }

    // TypedArray
    if (isTypedArray(value)) {
        return result
    }

    // Symbol & åŸå‹é“¾
    const keysFunc = isFull
    	? (isFlat ? getAllKeysIn : getAllKeys)
    	: (isFlat ? keysIn : keys)

    const props = isArr ? undefined : keysFunc(value)
    
    // éå†èµ‹å€¼
    arrayEach(props || value, (subValue, key) => {
        if (props) {
            key = subValue
            subValue = value[key]
        }
        assignValue(result, key, baseClone(subValue, bitmask, customizer, key, value, stack))
    })
    
    // è¿”å›ç»“æœ
    return result
}
```





## æ¯”è¾ƒ

| æ–¹æ³•                              | æ€§èƒ½               | å…¼å®¹æ€§           | æ”¯æŒå¤æ‚ç»“æ„ï¼ˆå¾ªç¯ã€å‡½æ•°ã€Symbol ç­‰ï¼‰             | é€‚ç”¨åœºæ™¯              |
| --------------------------------- | ------------------ | ---------------- | ------------------------------------------------- | --------------------- |
| `JSON.parse(JSON.stringify(obj))` | ğŸš€ å¿«               | âœ… é«˜             | âŒ ä¸æ”¯æŒå¾ªç¯ã€å‡½æ•°ã€`undefined`ã€`Date`ã€`Map` ç­‰ | ç®€å•å¯¹è±¡              |
| `lodash.cloneDeep(obj)`           | ğŸ¢ æ…¢               | âœ… é«˜             | âœ… æ”¯æŒå¤§éƒ¨åˆ†æƒ…å†µï¼Œæ”¯æŒå¾ªç¯å¼•ç”¨                    | å¤§å¤šæ•°é¡¹ç›®é€šç”¨        |
| `structuredClone(obj)`            | ğŸš€ğŸš€ éå¸¸å¿«          | âŒ æ–°æµè§ˆå™¨æ‰æ”¯æŒ | âœ… å†…å»ºæ”¯æŒ `Date`ã€`Map`ã€`Set`ã€å¾ªç¯å¼•ç”¨ç­‰       | ç°ä»£æµè§ˆå™¨æˆ– Node 17+ |
| æ‰‹å†™é€’å½’ï¼ˆæ·±æ‹·è´ï¼‰                | ğŸ¢~ğŸš€ æ€§èƒ½å› å®ç°è€Œå¼‚ | âœ… è‡ªå®šä¹‰         | âŒ é»˜è®¤ä¸æ”¯æŒå¤æ‚ç»“æ„ï¼Œéœ€æ‰‹åŠ¨å¤„ç†                  | å­¦ä¹ ç”¨é€”æˆ–é«˜åº¦å®šåˆ¶    |



## å‚è€ƒæ–‡çŒ®

[ æœ¨æ˜“æ¨å‰ç«¯è¿›é˜¶](https://muyiy.cn/blog/4/4.4.html)
